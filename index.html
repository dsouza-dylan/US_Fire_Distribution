<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Final Project Prototype: US Fire Distribution (2024)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <link rel="stylesheet" href="styles.css"> 
</head>
<body>

<h1 id="map-title">
  Final Project Prototype - United States: Active Fires (2024)
  <div class="header-controls">
    <div class="center-controls">
      <div id="loading-spinner" style="
        width: 25px;
        height: 25px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
      "></div>

      <div id="state-control">
        <button id="back-us" class="back-us-btn" style="display:none;">‚¨Ö US Map</button>
      </div>
    </div>

    <div class="header-right">
      <button class="mode-toggle" id="mode-toggle" aria-label="Toggle theme">
        <span class="icon">‚òÄÔ∏è</span>
      </button>
    </div>
  </div>
</h1>

<main>
<div id="map-wrap">
  <svg id="map"></svg>
  <div class="tooltip" id="tooltip"></div>
  <div class="debug-info" id="debug-info">Debug info will appear here</div>
</div>
<div id="legend-state" class="legend">
  <h3>Total FRP</h3>
  <div class="legend-item"><span style="background:#fffaf5"></span>0</div>
  <div class="legend-item"><span style="background:#ffebd6"></span>0 ‚Äì 1,000</div>
  <div class="legend-item"><span style="background:#ffc999"></span>1,000 ‚Äì 10,000</div>
  <div class="legend-item"><span style="background:#ff9c52"></span>10,000 ‚Äì 100,000</div>
  <div class="legend-item"><span style="background:#f97316"></span>100,000 ‚Äì 500,000</div>
  <div class="legend-item"><span style="background:#b54700"></span>500,000+</div>
</div>
<div id="legend-county" class="legend" style="display:none;">
  <h3>Total FRP</h3>
  <div class="legend-item"><span style="background:#fffaf5"></span>0</div>
  <div class="legend-item"><span style="background:#ffebd6"></span>1 ‚Äì 5</div>
  <div class="legend-item"><span style="background:#ffc999"></span>6 ‚Äì 25</div>
  <div class="legend-item"><span style="background:#ff9c52"></span>26 ‚Äì 100</div>
  <div class="legend-item"><span style="background:#f97316"></span>101 ‚Äì 500</div>
  <div class="legend-item"><span style="background:#b54700"></span>500+</div>
</div>
<section id="map-description" style="max-width:900px; padding-bottom: 100px; margin:40px auto; font-size:1rem; line-height:1.6; color:#ececec;">

    <p>So far our group has thought of what we want to do for the final project and what that is going to look like. There was a unique trend that we found amongst the fires in 2024 that we are able to craft a story that would lead to a unique insight. We decided that we wanted to build off our project 3 as there were unique features in our dataset that could be used to tell an interesting story. For example, we found that there was a trend where the sheer quantity of fires did not all occur in the west coast as many people know, but only the really bad fires occurred in the west coast were a lot of non-major fires in the eastern area of the country. We have started to talk about what we want our final project to look like and we are starting to draft the narrative and develop the story. We have started to delegate the work and have set some deliverables and when we want to get different parts of the final project done. We are making sure that we use the And, But! therefore framework. </p>
    <p>The most challenging part of the design is getting the interactive animation to work in a satisfying and smooth manner. We are attempting to make the interaction reinforce the story rather than take away from it. This interaction element, which is so crucial, needs to be almost invisible to the viewer but still lead them to the proper conclusion. This ‚Äòinvisible‚Äô interaction element is found through a balance between functions, view, interaction, and fluid responses of the element. Finding this balance is difficult as if we make our interactive animation ostentatious the reader will be drawn away from our narrative and focusing more on the ability of our animation. Alternatively, if our interactive design lags, causes frustration(from not working), or in any way inhibits the ability to convey our point properly and will further weaken our chance of persuading the viewer of our perspective. Furthermore, ensuring that this animation provides an equally positive user experience on multiple devices adds another layer of difficulty which can only be remedied by trial and error. This interaction between the user and interface is the hardest part to do yet plays an important role in our persuasion. Especially, since the final project requires that our visualization not only elucidates our narrative but also isn‚Äôt prevalent enough to take focus away from the point we are trying to convey. </p>
  </section>
</main>

<footer>
  <div class="bottom-navbar">
    <div class="slider-wrap">
      <label for="month-range-bottom" style="font-size:1rem; font-weight:700;">Month:</label>
      <input id="month-range-bottom" type="range" min="1" max="12" step="1" value="10">
      <div id="month-label-bottom" style="min-width:46px; text-align:left; font-weight:600;">Oct</div>
    </div>
  </div>
</footer>

<script>
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const STATE_NAMES = {
  '01':'alabama','02':'alaska','04':'arizona','05':'arkansas','06':'california','08':'colorado',
  '09':'connecticut','10':'delaware','12':'florida','13':'georgia','15':'hawaii','16':'idaho',
  '17':'illinois','18':'indiana','19':'iowa','20':'kansas','21':'kentucky','22':'louisiana',
  '23':'maine','24':'maryland','25':'massachusetts','26':'michigan','27':'minnesota','28':'mississippi',
  '29':'missouri','30':'montana','31':'nebraska','32':'nevada','33':'new_hampshire','34':'new_jersey',
  '35':'new_mexico','36':'new_york','37':'north_carolina','38':'north_dakota','39':'ohio','40':'oklahoma',
  '41':'oregon','42':'pennsylvania','44':'rhode_island','45':'south_carolina','46':'south_dakota',
  '47':'tennessee','48':'texas','49':'utah','50':'vermont','51':'virginia','53':'washington',
  '54':'west_virginia','55':'wisconsin','56':'wyoming'
};

const WIDTH = window.innerWidth;
const HEIGHT = window.innerHeight - 140;
const svg = d3.select('#map').attr('width', WIDTH).attr('height', HEIGHT);
const g = svg.append('g');
const tooltip = d3.select('#tooltip');
const debugInfo = d3.select('#debug-info');

let statesData=null, countiesData=null, usMonthlySummary={}, currentMode='us', currentStateName=null, currentStateData=[], currentStateCounties=[], monthlyFireData={};
let projection = d3.geoAlbersUsa().translate([WIDTH/2, HEIGHT/2]).scale(1000);
let path = d3.geoPath().projection(projection);

const backButton = document.getElementById('back-us');

function getStateBucketColor(count) {
  if (count === 0) return '#fffaf5';
  if (count <= 50) return '#ffebd6';
  if (count <= 200) return '#ffc999';
  if (count <= 500) return '#ff9c52';
  if (count <= 1500) return '#f97316';
  return '#b54700';
}

function getCountyBucketColor(count) {
  if (count === 0) return "#fffaf5";
  if (count <= 5) return "#ffebd6";
  if (count <= 25) return "#ffc999";
  if (count <= 100) return "#ff9c52";
  if (count <= 500) return "#f97316";
  return "#b54700";
}

  function getStateFRPColor(frp) {
  if (frp === 0) return '#fffaf5';
  if (frp <= 1000) return '#ffebd6';
  if (frp <= 10000) return '#ffc999';
  if (frp <= 100000) return '#ff9c52';
  if (frp <= 500000) return '#f97316';
  return '#b54700';
}

function getCountyFRPColor(frp) {
  if (frp === 0) return '#fffaf5';
  if (frp <= 50) return '#ffebd6';
  if (frp <= 250) return '#ffc999';
  if (frp <= 1000) return '#ff9c52';
  if (frp <= 5000) return '#f97316';
  return '#b54700';
}

function toggleBackButton(show) {
  backButton.style.display = show ? 'inline-flex' : 'none';
}

function updateDebugInfo(text) {
  debugInfo.html(text);
  console.log(text);
}

backButton.addEventListener('click',()=>{ drawUSView(+monthRangeBottom.value); });

Promise.all([
  d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json'),
  d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json'),
  d3.csv('us_summary_2024_monthly.csv')
]).then(([statesJson, countiesJson, summaryCsv])=>{
  statesData = topojson.feature(statesJson, statesJson.objects.states).features;
  countiesData = topojson.feature(countiesJson, countiesJson.objects.counties).features;
  
  summaryCsv.forEach(row=>{
    const state = row.state.toLowerCase();
    const month = +row.month;
    if(!usMonthlySummary[state]) usMonthlySummary[state]={};
    usMonthlySummary[state][month]={
      count: +row.fire_count, 
      brightness: +row.total_brightness,
      frp: +row.total_frp
    };
  });
  
  drawUSView(1);
  monthRangeBottom.value = 1;
  monthLabelBottom.textContent = MONTHS[9];
}).catch(err => {
  console.error('Error loading initial data:', err);
  alert('Failed to load map data: ' + err.message);
});

function drawUSView(monthNum=1){
  currentMode='us'; 
  currentStateName=null;
  toggleBackButton(false);
  
  projection = d3.geoAlbersUsa(); 
  path=d3.geoPath().projection(projection);
  const usFeature={type:"FeatureCollection", features:statesData};
  projection.fitSize([WIDTH, HEIGHT * 0.9], usFeature);
  
  g.transition().duration(750).attr('transform','translate(0,0) scale(1)');
  g.selectAll('*').remove();

  const stateFireData={};
  Object.keys(STATE_NAMES).forEach(fips=>{
    const stateName = STATE_NAMES[fips];
    const data = usMonthlySummary[stateName]?.[monthNum] || {count:0};
    stateFireData[fips]=data.count;
  });

  g.append('g').attr('id','states')
    .selectAll('path')
    .data(statesData)
    .enter()
    .append('path')
    .attr('class','state')
    .attr('d',path)
    .attr('fill', d => {
      const fips = String(d.id).padStart(2, '0');
      const stateName = STATE_NAMES[fips]; 
      const stateData = usMonthlySummary[stateName]?.[monthNum] || {count:0, frp:0};
      return getStateFRPColor(stateData.frp || 0);
    })
    .on('mouseover',(event,d)=>{
      const fips=String(d.id).padStart(2,'0'); 
      const stateName=STATE_NAMES[fips];
      const stateData = usMonthlySummary[stateName]?.[monthNum] || {count:0, frp:0};
      const fires = stateData.count || 0;
      const frp = stateData.frp || 0;
      tooltip.html(`<div style="font-weight:700">${stateName.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</div>
                    <div>${fires.toLocaleString()} fires (${MONTHS[monthNum-1]})</div>
                    <div>Total FRP: ${frp.toLocaleString()} MW</div>`)
        .style('left', event.pageX+'px')
        .style('top', event.pageY+'px')
        .classed('show', true);
    })
    .on('mouseout',()=>tooltip.classed('show',false))
    .on('click',(event,d)=>{
      if(currentMode === 'state') return;
      const fips=String(d.id).padStart(2,'0'); 
      const stateName=STATE_NAMES[fips];
      zoomToState(fips,stateName);
    });
    
  showStateLegend();
}

async function zoomToState(stateFips, stateName){
  const spinner = document.getElementById('loading-spinner');
  spinner.style.display = 'block';
  updateDebugInfo(`Loading ${stateName}...`);

  try {
    const csvData = await d3.csv(`state_data/${stateName}_2024.csv`);
    
    updateDebugInfo(`Loaded ${csvData.length} rows`);
    
    currentStateData = csvData.map(r => {
      const dateParts = r.acq_date.split('-');
      const year = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]);
      const day = parseInt(dateParts[2]);
      
      return {
        latitude: parseFloat(r.latitude), 
        longitude: parseFloat(r.longitude), 
        brightness: parseFloat(r.brightness) || 0,
        frp: parseFloat(r.frp) || 0,
        acq_date: r.acq_date,
        month: month
      };
    });

    console.log('Parsed fires:', currentStateData.length);
    console.log('Sample fire:', currentStateData[0]);

    currentMode = 'state'; 
    currentStateName = stateName;
    toggleBackButton(true);
    
    currentStateCounties = countiesData.filter(d => Math.floor(d.id/1000) === parseInt(stateFips));
    
    if(!currentStateCounties.length){
      alert('No county data for this state'); 
      spinner.style.display = 'none';
      return;
    }

    console.log('Counties found:', currentStateCounties.length);

    g.selectAll('#states path')
      .attr('opacity', d => {
        const fips = String(d.id).padStart(2, '0');
        return fips === stateFips ? 1 : 0.3;
      })
      .style('pointer-events', d => {
        const fips = String(d.id).padStart(2, '0');
        return fips === stateFips ? 'auto' : 'none';
      });
    
    precomputeMonthlyFireData();
    
    const currentMonth = parseInt(monthRangeBottom.value);
    drawCountyHeatmap(currentMonth);

    const bounds = path.bounds({type:"FeatureCollection", features:currentStateCounties});
    const dx = bounds[1][0] - bounds[0][0]; 
    const dy = bounds[1][1] - bounds[0][1];
    const x = (bounds[0][0] + bounds[1][0]) / 2; 
    const y = (bounds[0][1] + bounds[1][1]) / 2;
    const scale = 0.75 * Math.min(WIDTH/dx, HEIGHT/dy);
    const translate = [WIDTH/2 - scale*x, HEIGHT/2 - scale*y];
    
    g.transition().duration(750).attr('transform',`translate(${translate}) scale(${scale})`);
    
    showCountyLegend();

  } catch(err){
    console.error('Error loading state data:', err);
    alert("Failed to load state data: " + err.message);
    updateDebugInfo(`Error: ${err.message}`);
  } finally {
    spinner.style.display = 'none';
  }
}

const monthRangeBottom = document.getElementById('month-range-bottom');
const monthLabelBottom = document.getElementById('month-label-bottom');

monthRangeBottom.addEventListener('input', () => {
  const monthNum = parseInt(monthRangeBottom.value);
  monthLabelBottom.textContent = MONTHS[monthNum - 1];
  if (currentMode === 'state') {
    drawCountyHeatmap(monthNum);
  } else {
    drawUSView(monthNum);
  }
});

function precomputeMonthlyFireData(){
  monthlyFireData = {};
  monthlyFRPData = {}; // new object to store FRP

  currentStateCounties.forEach(c => {
    monthlyFireData[c.id] = Array(12).fill(0);
    monthlyFRPData[c.id] = Array(12).fill(0); // initialize FRP array
  });

  let matchedFires = 0;
  let unmatchedFires = 0;

  currentStateData.forEach(fire => {
    let matched = false;

    for(let i = 0; i < currentStateCounties.length; i++) {
      const county = currentStateCounties[i];
      try {
        if(d3.geoContains(county, [fire.longitude, fire.latitude])) {
          monthlyFireData[county.id][fire.month - 1]++;
          monthlyFRPData[county.id][fire.month - 1] += fire.frp || 0; // accumulate FRP
          matchedFires++;
          matched = true;
          break;
        }
      } catch(e) {
        // silently continue
      }
    }

    if(!matched) {
      unmatchedFires++;
    }
  });

  const debugText = `Fires: ${currentStateData.length}<br>Matched: ${matchedFires}<br>Unmatched: ${unmatchedFires}<br>Counties: ${currentStateCounties.length}`;
  updateDebugInfo(debugText);
}


function drawCountyHeatmap(monthNum){
  if(!currentStateCounties.length) return;

  currentStateCounties.forEach(c => {
    c.fireValue = monthlyFireData[c.id]?.[monthNum-1] || 0;
  });
  
  const maxValue = d3.max(currentStateCounties, d => d.fireValue) || 1;
  console.log(`Drawing heatmap for month ${monthNum}, max fires: ${maxValue}`);

  g.select('#counties').remove();

  g.append('g')
    .attr('id','counties')
    .selectAll('path')
    .data(currentStateCounties)
    .join('path')
    .attr('class','county')
    .attr('d', path)
    .attr('fill', d => {
      const frp = monthlyFRPData[d.id]?.[monthNum-1] || 0;
      const color = getCountyFRPColor(frp);
      return color;
    })
    .on('mouseover', (event, d) => {
      const countyName = d.properties?.name || 'Unknown';
      const fires = monthlyFireData[d.id]?.[monthNum-1] || 0;
      const frp = monthlyFRPData[d.id]?.[monthNum-1] || 0;

      tooltip.html(`<div style="font-weight:700">${countyName} County</div>
                    <div>${fires.toLocaleString()} fires (${MONTHS[monthNum-1]})</div>
                    <div>Total FRP: ${frp.toLocaleString()} MW</div>`)
        .style('left', event.pageX + 'px')
        .style('top', event.pageY + 'px')
        .classed('show', true);
    })
    .on('mouseout', () => tooltip.classed('show', false));
}

function showStateLegend() {
  document.getElementById("legend-state").style.display = "block";
  document.getElementById("legend-county").style.display = "none";
}

function showCountyLegend() {
  document.getElementById("legend-state").style.display = "none";
  document.getElementById("legend-county").style.display = "block";
}

const modeToggle = document.getElementById('mode-toggle');
const modeIcon = modeToggle.querySelector('.icon');

modeToggle.addEventListener('click', () => {
  document.body.classList.toggle('light-mode');
  modeIcon.textContent = document.body.classList.contains('light-mode') ? 'üåô' : '‚òÄÔ∏è';
});

// Show debug info temporarily for testing
// debugInfo.style('display', 'block');
</script>

</body>
</html>